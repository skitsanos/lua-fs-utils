name: LuaRocks Release

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: "Set latest tag"
        id: set-latest-tag
        run: |
          currentVersion=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{github.repository}}/tags | jq -r 'sort_by(.name | split(".") | map(tonumber)) | reverse | .[0].name')
          echo "LATEST_VERSION=$currentVersion" >> $GITHUB_ENV
      - run: echo "Current version is ${{env.LATEST_VERSION}}"

      - name: "Setup Lua"
        run: |
          sudo apt-get update
          sudo apt-get install -y lua5.1 luarocks

      - name: "Install semver"
        run: |
          # Download the script and save it to /usr/local/bin
          wget -O /usr/local/bin/semver https://raw.githubusercontent.com/fsaintjacques/semver-tool/master/src/semver
          # Make script executable
          chmod +x /usr/local/bin/semver
          # Prove it works
          semver --version

      - name: Increment version
        id: new_version
        run: |
          NEXT_VERSION=$(semver bump patch ${{env.LATEST_VERSION}})
          echo "NEXT_VERSION=$NEXT_VERSION" >> $GITHUB_OUTPUT

      - run: echo "Next version is ${{ steps.new_version.outputs.NEXT_VERSION }}"
#
#      - name: Create new tag
#        run: git tag -a ${{ steps.new_version.outputs.version }} -m "release version ${{ steps.new_version.outputs.version }}"
#
#      - name: Push new tag
#        run: git push origin ${{ steps.new_version.outputs.version }}
#
#      - name: Create rockspec
#        run: luarocks write_rockspec mymodule ${{ steps.new_version.outputs.version }}
#
#      - name: Package rock
#        run: luarocks pack mymodule-${{ steps.new_version.outputs.version }}-1.rockspec

#      - name: Upload rock
#        env:
#          LUAROCKS_USERNAME: ${{ secrets.LUAROCKS_USERNAME }}
#          LUAROCKS_PASSWORD: ${{ secrets.LUAR
